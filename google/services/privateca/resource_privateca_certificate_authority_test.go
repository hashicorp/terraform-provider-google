// Copyright (c) HashiCorp, Inc.
// SPDX-License-Identifier: MPL-2.0
// ----------------------------------------------------------------------------
//
//	***     AUTO GENERATED CODE    ***    Type: Handwritten     ***
//
// ----------------------------------------------------------------------------
//
//	This code is generated by Magic Modules using the following:
//
//	Source file: https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services/privateca/resource_privateca_certificate_authority_test.go
//
//	DO NOT EDIT this file directly. Any changes made to this file will be
//	overwritten during the next generation cycle.
//
// ----------------------------------------------------------------------------
package privateca_test

import (
	"testing"

	"github.com/hashicorp/terraform-plugin-testing/helper/resource"
	"github.com/hashicorp/terraform-provider-google/google/acctest"
)

func TestAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityUpdate(t *testing.T) {
	t.Parallel()

	context := map[string]interface{}{
		"pool_name":           acctest.BootstrapSharedCaPoolInLocation(t, "us-central1"),
		"pool_location":       "us-central1",
		"deletion_protection": false,
		"random_suffix":       acctest.RandString(t, 10),
	}

	acctest.VcrTest(t, resource.TestCase{
		PreCheck:                 func() { acctest.AccTestPreCheck(t) },
		ProtoV5ProviderFactories: acctest.ProtoV5ProviderFactories(t),
		CheckDestroy:             testAccCheckPrivatecaCertificateAuthorityDestroyProducer(t),
		Steps: []resource.TestStep{
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityBasicRoot(context),
				// we added a `desired_state` field in https://github.com/GoogleCloudPlatform/magic-modules/pull/5934, this ensures
				// we don't regress and that CAs are enabled by default
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr("google_privateca_certificate_authority.default", "state", "ENABLED"),
				),
			},
			{
				ResourceName:            "google_privateca_certificate_authority.default",
				ImportState:             true,
				ImportStateVerify:       true,
				ImportStateVerifyIgnore: []string{"ignore_active_certificates_on_deletion", "location", "certificate_authority_id", "pool", "deletion_protection", "skip_grace_period", "labels", "terraform_labels"},
			},
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityEnd(context),
			},
			{
				ResourceName:            "google_privateca_certificate_authority.default",
				ImportState:             true,
				ImportStateVerify:       true,
				ImportStateVerifyIgnore: []string{"ignore_active_certificates_on_deletion", "location", "certificate_authority_id", "pool", "deletion_protection", "skip_grace_period", "labels", "terraform_labels"},
			},
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityBasicRoot(context),
			},
			{
				ResourceName:            "google_privateca_certificate_authority.default",
				ImportState:             true,
				ImportStateVerify:       true,
				ImportStateVerifyIgnore: []string{"ignore_active_certificates_on_deletion", "location", "certificate_authority_id", "pool", "deletion_protection", "skip_grace_period", "labels", "terraform_labels"},
			},
		},
	})
}

func TestAccPrivatecaCertificateAuthority_rootCaManageDesiredState(t *testing.T) {
	t.Parallel()

	random_suffix := acctest.RandString(t, 10)
	context_staged := map[string]interface{}{
		"pool_name":           acctest.BootstrapSharedCaPoolInLocation(t, "us-central1"),
		"pool_location":       "us-central1",
		"deletion_protection": false,
		"random_suffix":       random_suffix,
		"desired_state":       "STAGED",
	}

	context_enabled := map[string]interface{}{
		"pool_name":           acctest.BootstrapSharedCaPoolInLocation(t, "us-central1"),
		"pool_location":       "us-central1",
		"deletion_protection": false,
		"random_suffix":       random_suffix,
		"desired_state":       "ENABLED",
	}

	context_disabled := map[string]interface{}{
		"pool_name":           acctest.BootstrapSharedCaPoolInLocation(t, "us-central1"),
		"pool_location":       "us-central1",
		"deletion_protection": false,
		"random_suffix":       random_suffix,
		"desired_state":       "DISABLED",
	}

	resourceName := "google_privateca_certificate_authority.default"
	acctest.VcrTest(t, resource.TestCase{
		PreCheck:                 func() { acctest.AccTestPreCheck(t) },
		ProtoV5ProviderFactories: acctest.ProtoV5ProviderFactories(t),
		CheckDestroy:             testAccCheckPrivatecaCertificateAuthorityDestroyProducer(t),
		Steps: []resource.TestStep{
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityWithDesiredState(context_staged),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "state", "STAGED"),
				),
			},
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityWithDesiredState(context_enabled),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "state", "ENABLED"),
				),
			},
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityWithDesiredState(context_disabled),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "state", "DISABLED"),
				),
			},
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityWithDesiredState(context_enabled),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "state", "ENABLED"),
				),
			},
		},
	})
}

func TestAccPrivatecaCertificateAuthority_subordinateCaActivatedByFirstPartyIssuerOnCreation(t *testing.T) {
	t.Parallel()
	acctest.SkipIfVcr(t)

	random_suffix := acctest.RandString(t, 10)
	context := map[string]interface{}{
		"root_location":     "us-central1",
		"sub_location":      "australia-southeast1",
		"random_suffix":     random_suffix,
		"first_label_value": "bar",
	}

	resourceName := "google_privateca_certificate_authority.sub-1"
	acctest.VcrTest(t, resource.TestCase{
		PreCheck:                 func() { acctest.AccTestPreCheck(t) },
		ProtoV5ProviderFactories: acctest.ProtoV5ProviderFactories(t),
		CheckDestroy:             testAccCheckPrivatecaCertificateAuthorityDestroyProducer(t),
		Steps: []resource.TestStep{
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthoritySubordinateWithFirstPartyIssuer(context),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "state", "ENABLED"),
				),
			},
		},
	})
}

func TestAccPrivatecaCertificateAuthority_subordinateCaActivatedByFirstPartyIssuerOnCreationInStagedState(t *testing.T) {
	t.Parallel()
	acctest.SkipIfVcr(t)

	random_suffix := acctest.RandString(t, 10)
	context := map[string]interface{}{
		"root_location": "us-central1",
		"sub_location":  "australia-southeast1",
		"random_suffix": random_suffix,
	}

	resourceName := "google_privateca_certificate_authority.sub-1"
	acctest.VcrTest(t, resource.TestCase{
		PreCheck:                 func() { acctest.AccTestPreCheck(t) },
		ProtoV5ProviderFactories: acctest.ProtoV5ProviderFactories(t),
		CheckDestroy:             testAccCheckPrivatecaCertificateAuthorityDestroyProducer(t),
		Steps: []resource.TestStep{
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthoritySubordinateStagedWithFirstPartyIssuer(context),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "state", "STAGED"),
				),
			},
		},
	})
}

func TestAccPrivatecaCertificateAuthority_subordinateCaCanUpdateLabel(t *testing.T) {
	t.Parallel()
	acctest.SkipIfVcr(t)

	random_suffix := acctest.RandString(t, 10)
	context1 := map[string]interface{}{
		"root_location":     "us-central1",
		"sub_location":      "australia-southeast1",
		"random_suffix":     random_suffix,
		"first_label_value": "bar-1",
	}

	context2 := map[string]interface{}{
		"root_location":     "us-central1",
		"sub_location":      "australia-southeast1",
		"random_suffix":     random_suffix,
		"first_label_value": "bar-2",
	}

	resourceName := "google_privateca_certificate_authority.sub-1"
	acctest.VcrTest(t, resource.TestCase{
		PreCheck:                 func() { acctest.AccTestPreCheck(t) },
		ProtoV5ProviderFactories: acctest.ProtoV5ProviderFactories(t),
		CheckDestroy:             testAccCheckPrivatecaCertificateAuthorityDestroyProducer(t),
		Steps: []resource.TestStep{
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthoritySubordinateWithFirstPartyIssuer(context1),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "labels.first_label", context1["first_label_value"].(string)),
				),
			},
			{
				Config: testAccPrivatecaCertificateAuthority_privatecaCertificateAuthoritySubordinateWithFirstPartyIssuer(context2),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(resourceName, "labels.first_label", context2["first_label_value"].(string)),
				),
			},
		},
	})
}

func testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityBasicRoot(context map[string]interface{}) string {
	return acctest.Nprintf(`
resource "google_privateca_certificate_authority" "default" {
	// This example assumes this pool already exists.
	// Pools cannot be deleted in normal test circumstances, so we depend on static pools
	pool = "%{pool_name}"
	certificate_authority_id = "tf-test-my-certificate-authority-%{random_suffix}"
	location = "%{pool_location}"
	deletion_protection = false
	skip_grace_period = true
	config {
		subject_config {
		subject {
			organization = "HashiCorp"
			common_name = "my-certificate-authority"
		}
		subject_alt_name {
			dns_names = ["hashicorp.com"]
		}
		}
		x509_config {
		ca_options {
			is_ca = true
			max_issuer_path_length = 10
		}
		key_usage {
			base_key_usage {
			digital_signature = true
			content_commitment = true
			key_encipherment = false
			data_encipherment = true
			key_agreement = true
			cert_sign = true
			crl_sign = true
			decipher_only = true
			}
			extended_key_usage {
			server_auth = true
			client_auth = false
			email_protection = true
			code_signing = true
			time_stamping = true
			}
		}
		}
	}
	lifetime = "86400s"
	key_spec {
		algorithm = "RSA_PKCS1_4096_SHA256"
	}
}
`, context)
}

func testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityEnd(context map[string]interface{}) string {
	return acctest.Nprintf(`
resource "google_privateca_certificate_authority" "default" {
	// This example assumes this pool already exists.
	// Pools cannot be deleted in normal test circumstances, so we depend on static pools
	pool = "%{pool_name}"
	certificate_authority_id = "tf-test-my-certificate-authority-%{random_suffix}"
	location = "%{pool_location}"
	deletion_protection = false
	skip_grace_period = true
	config {
		subject_config {
		subject {
			organization = "HashiCorp"
			common_name = "my-certificate-authority"
		}
		subject_alt_name {
			dns_names = ["hashicorp.com"]
		}
		}
		x509_config {
		ca_options {
			is_ca = true
			max_issuer_path_length = 10
		}
		key_usage {
			base_key_usage {
			digital_signature = true
			content_commitment = true
			key_encipherment = false
			data_encipherment = true
			key_agreement = true
			cert_sign = true
			crl_sign = true
			decipher_only = true
			}
			extended_key_usage {
			server_auth = true
			client_auth = false
			email_protection = true
			code_signing = true
			time_stamping = true
			}
		}
		}
	}
	lifetime = "86400s"
	key_spec {
		algorithm = "RSA_PKCS1_4096_SHA256"
	}
	labels = {
		foo = "bar"
	}
}
`, context)
}

func testAccPrivatecaCertificateAuthority_privatecaCertificateAuthorityWithDesiredState(context map[string]interface{}) string {
	return acctest.Nprintf(`
resource "google_privateca_certificate_authority" "default" {
	// This example assumes this pool already exists.
	// Pools cannot be deleted in normal test circumstances, so we depend on static pools
	pool = "%{pool_name}"
	certificate_authority_id = "tf-test-my-certificate-authority-%{random_suffix}"
	location = "%{pool_location}"
	desired_state = "%{desired_state}"
	deletion_protection = false
	skip_grace_period = true
	config {
		subject_config {
		subject {
			organization = "HashiCorp"
			common_name = "my-certificate-authority"
		}
		subject_alt_name {
			dns_names = ["hashicorp.com"]
		}
		}
		x509_config {
		ca_options {
			is_ca = true
			max_issuer_path_length = 10
		}
		key_usage {
			base_key_usage {
			digital_signature = true
			content_commitment = true
			key_encipherment = false
			data_encipherment = true
			key_agreement = true
			cert_sign = true
			crl_sign = true
			decipher_only = true
			}
			extended_key_usage {
			server_auth = true
			client_auth = false
			email_protection = true
			code_signing = true
			time_stamping = true
			}
		}
		}
	}
	lifetime = "86400s"
	key_spec {
		algorithm = "RSA_PKCS1_4096_SHA256"
	}
}
`, context)
}

// testAccPrivatecaCertificateAuthority_privatecaCertificateAuthoritySubordinateWithFirstPartyIssuer provides a config
// which contains
// * A CaPool for root CA
// * A root CA
// * A CaPool for sub CA
// * A subordinate CA which should be activated by the above root CA
func testAccPrivatecaCertificateAuthority_privatecaCertificateAuthoritySubordinateWithFirstPartyIssuer(context map[string]interface{}) string {
	return acctest.Nprintf(`
resource "google_privateca_ca_pool" "root-pool" {
	name     = "root-pool-%{random_suffix}"
	location = "%{root_location}"
	tier     = "ENTERPRISE"
	publishing_options {
	  publish_ca_cert = true
	  publish_crl     = true
	}
}

resource "google_privateca_certificate_authority" "root-1" {
	pool = google_privateca_ca_pool.root-pool.name 
	certificate_authority_id = "tf-test-my-certificate-authority-root-%{random_suffix}"
	location = "%{root_location}"
	config {
		subject_config {
		subject {
			organization = "HashiCorp"
			common_name = "my-certificate-authority"
		}
		subject_alt_name {
			dns_names = ["hashicorp.com"]
		}
		}
		x509_config {
		ca_options {
			is_ca = true
			max_issuer_path_length = 10
		}
		key_usage {
			base_key_usage {
			digital_signature = true
			content_commitment = true
			key_encipherment = false
			data_encipherment = true
			key_agreement = true
			cert_sign = true
			crl_sign = true
			decipher_only = true
			}
			extended_key_usage {
			server_auth = true
			client_auth = false
			email_protection = true
			code_signing = true
			time_stamping = true
			}
		}
		}
	}
	lifetime = "86400s"
	key_spec {
		algorithm = "RSA_PKCS1_4096_SHA256"
	}

	// Disable CA deletion related safe checks for easier cleanup.
	deletion_protection                    = false
	skip_grace_period                      = true
	ignore_active_certificates_on_deletion = true
}

resource "google_privateca_ca_pool" "sub-pool" {
	name     = "sub-pool-%{random_suffix}"
	location = "%{sub_location}"
	tier     = "ENTERPRISE"
	publishing_options {
	  publish_ca_cert = true
	  publish_crl     = true
	}
}

resource "google_privateca_certificate_authority" "sub-1" {
	pool = google_privateca_ca_pool.sub-pool.name 
	certificate_authority_id = "tf-test-my-certificate-authority-sub-%{random_suffix}"
	location = "%{sub_location}"
	subordinate_config {
		certificate_authority = google_privateca_certificate_authority.root-1.name
	}
	config {
		subject_config {
		subject {
			organization = "HashiCorp"
			common_name = "my-certificate-authority"
		}
		subject_alt_name {
			dns_names = ["hashicorp.com"]
		}
		}
		x509_config {
		ca_options {
			is_ca = true
			max_issuer_path_length = 10
		}
		key_usage {
			base_key_usage {
			digital_signature = true
			content_commitment = true
			key_encipherment = false
			data_encipherment = true
			key_agreement = true
			cert_sign = true
			crl_sign = true
			decipher_only = true
			}
			extended_key_usage {
			server_auth = true
			client_auth = false
			email_protection = true
			code_signing = true
			time_stamping = true
			}
		}
		}
	}
	lifetime = "86400s"
	key_spec {
		algorithm = "RSA_PKCS1_4096_SHA256"
	}
	type = "SUBORDINATE"

	labels = {
		first_label = "%{first_label_value}"
	}

	// Disable CA deletion related safe checks for easier cleanup.
	deletion_protection                    = false
	skip_grace_period                      = true
	ignore_active_certificates_on_deletion = true
}
`, context)
}

// testAccPrivatecaCertificateAuthority_privatecaCertificateAuthoritySubordinateStagedWithFirstPartyIssuer provides a config
// which contains
// * A CaPool for root CA
// * A root CA
// * A CaPool for sub CA
// * A subordinate CA which should be activated by the above root CA
func testAccPrivatecaCertificateAuthority_privatecaCertificateAuthoritySubordinateStagedWithFirstPartyIssuer(context map[string]interface{}) string {
	return acctest.Nprintf(`
resource "google_privateca_ca_pool" "root-pool" {
	name     = "root-pool-%{random_suffix}"
	location = "%{root_location}"
	tier     = "ENTERPRISE"
	publishing_options {
	  publish_ca_cert = true
	  publish_crl     = true
	}
}

resource "google_privateca_certificate_authority" "root-1" {
	pool = google_privateca_ca_pool.root-pool.name 
	certificate_authority_id = "tf-test-my-certificate-authority-root-%{random_suffix}"
	location = "%{root_location}"
	config {
		subject_config {
		subject {
			organization = "HashiCorp"
			common_name = "my-certificate-authority"
		}
		subject_alt_name {
			dns_names = ["hashicorp.com"]
		}
		}
		x509_config {
		ca_options {
			is_ca = true
			max_issuer_path_length = 10
		}
		key_usage {
			base_key_usage {
			digital_signature = true
			content_commitment = true
			key_encipherment = false
			data_encipherment = true
			key_agreement = true
			cert_sign = true
			crl_sign = true
			decipher_only = true
			}
			extended_key_usage {
			server_auth = true
			client_auth = false
			email_protection = true
			code_signing = true
			time_stamping = true
			}
		}
		}
	}
	lifetime = "86400s"
	key_spec {
		algorithm = "RSA_PKCS1_4096_SHA256"
	}

	// Disable CA deletion related safe checks for easier cleanup.
	deletion_protection                    = false
	skip_grace_period                      = true
	ignore_active_certificates_on_deletion = true
}

resource "google_privateca_ca_pool" "sub-pool" {
	name     = "sub-pool-%{random_suffix}"
	location = "%{sub_location}"
	tier     = "ENTERPRISE"
	publishing_options {
	  publish_ca_cert = true
	  publish_crl     = true
	}
}

resource "google_privateca_certificate_authority" "sub-1" {
	pool = google_privateca_ca_pool.sub-pool.name 
	certificate_authority_id = "tf-test-my-certificate-authority-sub-%{random_suffix}"
	location = "%{sub_location}"
	desired_state = "STAGED"
	subordinate_config {
		certificate_authority = google_privateca_certificate_authority.root-1.name
	}
	config {
		subject_config {
		subject {
			organization = "HashiCorp"
			common_name = "my-certificate-authority"
		}
		subject_alt_name {
			dns_names = ["hashicorp.com"]
		}
		}
		x509_config {
		ca_options {
			is_ca = true
			max_issuer_path_length = 10
		}
		key_usage {
			base_key_usage {
			digital_signature = true
			content_commitment = true
			key_encipherment = false
			data_encipherment = true
			key_agreement = true
			cert_sign = true
			crl_sign = true
			decipher_only = true
			}
			extended_key_usage {
			server_auth = true
			client_auth = false
			email_protection = true
			code_signing = true
			time_stamping = true
			}
		}
		}
	}
	lifetime = "86400s"
	key_spec {
		algorithm = "RSA_PKCS1_4096_SHA256"
	}
	type = "SUBORDINATE"

	// Disable CA deletion related safe checks for easier cleanup.
	deletion_protection                    = false
	skip_grace_period                      = true
	ignore_active_certificates_on_deletion = true
}
`, context)
}
