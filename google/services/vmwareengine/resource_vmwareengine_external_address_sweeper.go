// Copyright (c) HashiCorp, Inc.
// SPDX-License-Identifier: MPL-2.0

// ----------------------------------------------------------------------------
//
//     ***     AUTO GENERATED CODE    ***    Type: MMv1     ***
//
// ----------------------------------------------------------------------------
//
//     This code is generated by Magic Modules using the following:
//
//     Configuration: https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/products/vmwareengine/ExternalAddress.yaml
//     Template:      https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/templates/terraform/sweeper_file.go.tmpl
//
//     DO NOT EDIT this file directly. Any changes made to this file will be
//     overwritten during the next generation cycle.
//
// ----------------------------------------------------------------------------

package vmwareengine

import (
	"context"
	"fmt"
	"log"
	"strings"
	"testing"

	"github.com/hashicorp/terraform-provider-google/google/envvar"
	"github.com/hashicorp/terraform-provider-google/google/sweeper"
	"github.com/hashicorp/terraform-provider-google/google/tpgresource"
	transport_tpg "github.com/hashicorp/terraform-provider-google/google/transport"
)

func init() {
	// Initialize base sweeper object
	s := &sweeper.Sweeper{
		Name:           "google_vmwareengine_external_address",
		ListAndAction:  listAndActionVmwareengineExternalAddress,
		DeleteFunction: testSweepVmwareengineExternalAddress,
	}
	// Add parent relationship
	s.Parents = []string{"google_vmwareengine_private_cloud"}

	// Register the sweeper
	sweeper.AddTestSweepers(s)
}

func testSweepVmwareengineExternalAddress(_ string) error {
	return listAndActionVmwareengineExternalAddress(deleteResourceVmwareengineExternalAddress)
}

func listAndActionVmwareengineExternalAddress(action sweeper.ResourceAction) error {
	var lastError error
	resourceName := "VmwareengineExternalAddress"
	log.Printf("[INFO][SWEEPER_LOG] Starting sweeper for %s", resourceName)

	// Prepare configurations to iterate over
	var configs []*tpgresource.ResourceDataMock
	// This resource has a parent dependency
	parentType := "google_vmwareengine_private_cloud"
	log.Printf("[INFO][SWEEPER_LOG] %s depends on parent resource %s", resourceName, parentType)

	// Get parent sweeper and collect parent references
	parentSweeper, ok := sweeper.GetSweeper(parentType)
	if !ok {
		return fmt.Errorf("parent sweeper for %s not found", parentType)
	}

	// Run parent's ListAndAction to collect parent references
	if err := parentSweeper.ListAndAction(collectParentConfigVmwareengineExternalAddress(&configs)); err != nil {
		log.Printf("[INFO][SWEEPER_LOG] Error collecting parent references: %s", err)
		return err
	}

	log.Printf("[INFO][SWEEPER_LOG] Found %d parent resources for %s", len(configs), resourceName)

	// Process all configurations (either from parent resources or direct substitutions)
	for _, mockConfig := range configs {
		// Get region from config
		region := sweeper.GetFieldOrDefault(mockConfig, "region", "us-central1")

		// Create shared config for this region
		config, err := sweeper.SharedConfigForRegion(region)
		if err != nil {
			log.Printf("[INFO][SWEEPER_LOG] error getting shared config for region: %s", err)
			lastError = err
			continue
		}

		err = config.LoadAndValidate(context.Background())
		if err != nil {
			log.Printf("[INFO][SWEEPER_LOG] error loading: %s", err)
			lastError = err
			continue
		}

		// Prepare list URL
		listTemplate := strings.Split("https://vmwareengine.googleapis.com/v1/{{parent}}/externalAddresses", "?")[0]
		listUrl, err := tpgresource.ReplaceVars(mockConfig, config, listTemplate)
		if err != nil {
			log.Printf("[INFO][SWEEPER_LOG] error preparing sweeper list url: %s", err)
			lastError = err
			continue
		}

		// Log additional info for parent-based resources
		parentValue := ""
		if v, ok := mockConfig.FieldsInSchema["parent"]; ok {
			parentValue = v.(string)
		}
		log.Printf("[INFO][SWEEPER_LOG] Listing %s resources for parent %s at %s", resourceName, parentValue, listUrl)

		res, err := transport_tpg.SendRequest(transport_tpg.SendRequestOptions{
			Config:    config,
			Method:    "GET",
			Project:   config.Project,
			RawURL:    listUrl,
			UserAgent: config.UserAgent,
		})
		if err != nil {
			log.Printf("[INFO][SWEEPER_LOG] Error in response from request %s: %s", listUrl, err)
			lastError = err
			continue
		}

		// First try the expected resource key
		resourceList, ok := res["externalAddresses"]
		if ok {
			log.Printf("[INFO][SWEEPER_LOG] Found resources under expected key 'externalAddresses'")
		} else {
			// Next, try the common "items" pattern
			resourceList, ok = res["items"]
			if ok {
				log.Printf("[INFO][SWEEPER_LOG] Found resources under standard 'items' key")
			} else {
				log.Printf("[INFO][SWEEPER_LOG] no resources found")
				continue
			}
		}
		rl := resourceList.([]interface{})

		log.Printf("[INFO][SWEEPER_LOG] Found %d items in %s list response.", len(rl), resourceName)
		// Keep count of items that aren't sweepable for logging.
		nonPrefixCount := 0
		for _, ri := range rl {
			obj, ok := ri.(map[string]interface{})
			if !ok {
				log.Printf("[INFO][SWEEPER_LOG] Item was not a map: %T", ri)
				continue
			}

			if err := action(config, mockConfig, obj); err != nil {
				log.Printf("[INFO][SWEEPER_LOG] Error in action: %s", err)
				lastError = err
			} else {
				nonPrefixCount++
			}
		}
	}

	return lastError
}

func deleteResourceVmwareengineExternalAddress(config *transport_tpg.Config, d *tpgresource.ResourceDataMock, obj map[string]interface{}) error {
	var deletionerror error
	resourceName := "VmwareengineExternalAddress"
	var name string
	if obj["name"] == nil {
		log.Printf("[INFO][SWEEPER_LOG] %s resource name was nil", resourceName)
		return fmt.Errorf("%s resource name was nil", resourceName)
	}

	name = tpgresource.GetResourceNameFromSelfLink(obj["name"].(string))

	// Skip resources that shouldn't be sweeped
	if !sweeper.IsSweepableTestResource(name) {
		return nil
	}

	deleteTemplate := "https://vmwareengine.googleapis.com/v1/{{parent}}/externalAddresses/{{name}}"

	url, err := tpgresource.ReplaceVars(d, config, deleteTemplate)
	if err != nil {
		log.Printf("[INFO][SWEEPER_LOG] error preparing delete url: %s", err)
		deletionerror = err
	}
	url = url + name

	// Don't wait on operations as we may have a lot to delete
	_, err = transport_tpg.SendRequest(transport_tpg.SendRequestOptions{
		Config:    config,
		Method:    "DELETE",
		Project:   config.Project,
		RawURL:    url,
		UserAgent: config.UserAgent,
	})
	if err != nil {
		log.Printf("[INFO][SWEEPER_LOG] Error deleting for url %s : %s", url, err)
		deletionerror = err
	} else {
		log.Printf("[INFO][SWEEPER_LOG] Sent delete request for %s resource: %s", resourceName, name)
	}

	return deletionerror
}

// collectParentConfigVmwareengineExternalAddress returns a function that collects parent configurations
func collectParentConfigVmwareengineExternalAddress(configs *[]*tpgresource.ResourceDataMock) sweeper.ResourceAction {
	return func(config *transport_tpg.Config, d *tpgresource.ResourceDataMock, parentObj map[string]interface{}) error {
		// Get region/zone/location with fallbacks
		region := sweeper.GetFieldOrDefault(d, "region", "us-central1")
		zone := sweeper.GetFieldOrDefault(d, "zone", region+"-a")
		location := sweeper.GetFieldOrDefault(d, "location", region)

		// Create a new ResourceDataMock for the final child configuration
		childConfig := &tpgresource.ResourceDataMock{
			FieldsInSchema: map[string]interface{}{
				"project":  config.Project,
				"region":   region,
				"zone":     zone,
				"location": location,
			},
		}

		// Add billing account if testing environment requires it
		t := &testing.T{}
		billingId := envvar.GetTestBillingAccountFromEnv(t)
		if billingId != "" {
			childConfig.FieldsInSchema["billing_account"] = billingId
		}
		// Using direct field approach for parent reference

		// Extract the parent field value needed for child resources
		if parentObj["name"] == nil {
			log.Printf("[INFO][SWEEPER_LOG] Parent google_vmwareengine_private_cloud field name was nil, skipping")
			return nil
		}

		parentValue := parentObj["name"].(string)

		// Process the parent value based on configuration

		// Use parent value directly for the child resource
		childConfig.FieldsInSchema["parent"] = parentValue

		// Add to our list of configs to process
		*configs = append(*configs, childConfig)

		return nil
	}
}
