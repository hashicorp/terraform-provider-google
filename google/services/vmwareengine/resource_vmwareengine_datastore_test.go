// Copyright (c) HashiCorp, Inc.
// SPDX-License-Identifier: MPL-2.0
// ----------------------------------------------------------------------------
//
//	***     AUTO GENERATED CODE    ***    Type: Handwritten     ***
//
// ----------------------------------------------------------------------------
//
//	This code is generated by Magic Modules using the following:
//
//	Source file: https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/services/vmwareengine/resource_vmwareengine_datastore_test.go
//
//	DO NOT EDIT this file directly. Any changes made to this file will be
//	overwritten during the next generation cycle.
//
// ----------------------------------------------------------------------------
package vmwareengine_test

import (
	"fmt"
	"strings"
	"testing"

	"github.com/hashicorp/terraform-plugin-testing/helper/resource"
	"github.com/hashicorp/terraform-plugin-testing/terraform"

	"github.com/hashicorp/terraform-plugin-testing/plancheck"
	"github.com/hashicorp/terraform-provider-google/google/acctest"
	"github.com/hashicorp/terraform-provider-google/google/envvar"
	"github.com/hashicorp/terraform-provider-google/google/tpgresource"
	transport_tpg "github.com/hashicorp/terraform-provider-google/google/transport"
)

func TestAccVmwareengineDatastore_vmwareEngineDatastoreThirdparty_update(t *testing.T) {
	t.Parallel()

	context := map[string]interface{}{
		"region":        envvar.GetTestRegionFromEnv(),
		"random_suffix": acctest.RandString(t, 10),
	}

	acctest.VcrTest(t, resource.TestCase{
		PreCheck:                 func() { acctest.AccTestPreCheck(t) },
		ProtoV5ProviderFactories: acctest.ProtoV5ProviderFactories(t),
		CheckDestroy:             testAccCheckVmwareengineDatastoreDestroyProducer(t),
		Steps: []resource.TestStep{
			{
				Config: testAccVmwareengineDatastore_vmwareEngineDatastoreThirdparty(context, "test description"),
			},
			{
				ResourceName:            "google_vmwareengine_datastore.example_thirdparty",
				ImportState:             true,
				ImportStateVerify:       true,
				ImportStateVerifyIgnore: []string{"name", "location"},
			},
			{
				Config: testAccVmwareengineDatastore_vmwareEngineDatastoreThirdparty(context, "updated test description"),
				ConfigPlanChecks: resource.ConfigPlanChecks{
					PreApply: []plancheck.PlanCheck{
						plancheck.ExpectResourceAction("google_vmwareengine_datastore.example_thirdparty", plancheck.ResourceActionUpdate),
					},
				},
			},
		},
	})
}

func testAccVmwareengineDatastore_vmwareEngineDatastoreThirdparty(context map[string]interface{}, description string) string {
	context["description"] = description
	return acctest.Nprintf(`
data "google_compute_network" "default" {
  name      = "default"
  provider  = google
}

resource "google_vmwareengine_datastore" "example_thirdparty" {
  name        = "tf-test-thirdparty-datastore%{random_suffix}"
  location    = "%{region}-a"
  description = "%{description}"

  nfs_datastore {
    third_party_file_service {
      file_share  = "/share1"
      network     = data.google_compute_network.default.id
      servers     = ["10.0.0.4"]
    }
  }
}
`, context)
}

func TestAccVmwareengineDatastore_vmwareEngineDatastoreFilestore_update(t *testing.T) {
	t.Parallel()
	acctest.BootstrapIamMembers(t, []acctest.IamMember{
		{
			Member: "serviceAccount:service-{project_number}@gcp-sa-vmwareengine.iam.gserviceaccount.com",
			Role:   "roles/file.viewer",
		},
	})

	context := map[string]interface{}{
		"region":        envvar.GetTestRegionFromEnv(),
		"zone":          envvar.GetTestZoneFromEnv(),
		"network_name":  acctest.BootstrapSharedServiceNetworkingConnection(t, "datastore-test"),
		"random_suffix": acctest.RandString(t, 10),
	}

	acctest.VcrTest(t, resource.TestCase{
		PreCheck:                 func() { acctest.AccTestPreCheck(t) },
		ProtoV5ProviderFactories: acctest.ProtoV5ProviderFactories(t),
		CheckDestroy:             testAccCheckVmwareengineDatastoreDestroyProducer(t),
		Steps: []resource.TestStep{
			{
				Config: testAccVmwareengineDatastore_vmwareEngineDatastoreFilestore(context, true, "example google_file_service.filestore datastore."),
			},
			{
				ResourceName:            "google_vmwareengine_datastore.example_filestore",
				ImportState:             true,
				ImportStateVerify:       true,
				ImportStateVerifyIgnore: []string{"location", "name"},
			},
			{
				Config: testAccVmwareengineDatastore_vmwareEngineDatastoreFilestore(context, true, "updated example google_file_service.filestore datastore."),
				ConfigPlanChecks: resource.ConfigPlanChecks{
					PreApply: []plancheck.PlanCheck{
						plancheck.ExpectResourceAction("google_vmwareengine_datastore.example_filestore", plancheck.ResourceActionUpdate),
					},
				},
			},
			{
				Config: testAccVmwareengineDatastore_vmwareEngineDatastoreFilestore(context, false, "updated example google_file_service.filestore datastore."),
			},
		},
	})
}

func testAccVmwareengineDatastore_vmwareEngineDatastoreFilestore(context map[string]interface{}, delete_protection bool, description string) string {
	context["delete_protection"] = delete_protection
	context["description"] = description
	return acctest.Nprintf(`
# Use existing network with address created and PSA enabled.
data "google_compute_network" "test_network" {
  name = "%{network_name}"
}

# Create a filestore instance with delete protection enabled
resource "google_filestore_instance" "test_instance" {
  name                        = "tf-test-datastore-fs-instance%{random_suffix}"
  location                    = "%{zone}"
  tier                        = "ZONAL"
  deletion_protection_enabled = "%{delete_protection}"

  file_shares {
    capacity_gb = 1024
    name        = "share1"
  }

  networks {
    network       = data.google_compute_network.test_network.id
    modes         = ["MODE_IPV4"]
    connect_mode  = "PRIVATE_SERVICE_ACCESS"
  }
}

# Create a VmwareEngine Datastore, referencing the filestore instance
resource "google_vmwareengine_datastore" "example_filestore" {
  name        = "tf-test-filestore-datastore%{random_suffix}"
  location    = "%{zone}"
  description = "%{description}"

  nfs_datastore {
    google_file_service {
      filestore_instance = google_filestore_instance.test_instance.id
    }
  }
}
`, context)
}

func TestAccVmwareengineDatastore_vmwareEngineDatastoreNetapp_update(t *testing.T) {
	t.Parallel()
	acctest.BootstrapIamMembers(t, []acctest.IamMember{
		{
			Member: "serviceAccount:service-{project_number}@gcp-sa-vmwareengine.iam.gserviceaccount.com",
			Role:   "roles/netapp.viewer",
		},
	})

	context := map[string]interface{}{
		"region":        envvar.GetTestRegionFromEnv(),
		"zone":          envvar.GetTestZoneFromEnv(),
		"network_name":  acctest.BootstrapSharedServiceNetworkingConnection(t, "datastore-test", acctest.ServiceNetworkWithParentService("netapp.servicenetworking.goog")),
		"random_suffix": acctest.RandString(t, 10),
	}

	acctest.VcrTest(t, resource.TestCase{
		PreCheck:                 func() { acctest.AccTestPreCheck(t) },
		ProtoV5ProviderFactories: acctest.ProtoV5ProviderFactories(t),
		CheckDestroy:             testAccCheckVmwareengineDatastoreDestroyProducer(t),
		Steps: []resource.TestStep{
			{
				Config: testAccVmwareengineDatastore_vmwareEngineDatastoreNetapp(context, "example google_file_service.netapp datastore."),
			},
			{
				ResourceName:            "google_vmwareengine_datastore.example_netapp",
				ImportState:             true,
				ImportStateVerify:       true,
				ImportStateVerifyIgnore: []string{"location", "name"},
			},
			{
				Config: testAccVmwareengineDatastore_vmwareEngineDatastoreNetapp(context, "updated example google_file_service.netapp datastore."),
				ConfigPlanChecks: resource.ConfigPlanChecks{
					PreApply: []plancheck.PlanCheck{
						plancheck.ExpectResourceAction("google_vmwareengine_datastore.example_netapp", plancheck.ResourceActionUpdate),
					},
				},
			},
		},
	})
}

func testAccVmwareengineDatastore_vmwareEngineDatastoreNetapp(context map[string]interface{}, description string) string {
	context["description"] = description
	return acctest.Nprintf(`
# Create a network or use datasource to reference existing network
data "google_compute_network" "vpc_network" {
  name      = "%{network_name}"
}

# Create a Netapp storage pool
resource "google_netapp_storage_pool" "test_pool" {
  name          = "tf-test-netapp-storage-pool%{random_suffix}"
  location      = "%{region}"
  zone          = "%{region}-b"
  replica_zone  = "%{region}-a"
  service_level = "FLEX"
  capacity_gib  = "2048"
  network       = data.google_compute_network.vpc_network.id
	lifecycle {
    ignore_changes = [
      qos_type,
    ]
  }
}

# Create a netapp volume
resource "google_netapp_volume" "test_volume" {
  location            = "%{region}"
  name                = "tf-test-netapp-volume%{random_suffix}"
  capacity_gib        = "1024"
  share_name          = "share1"
  storage_pool        = google_netapp_storage_pool.test_pool.name
  protocols           = [ "NFSV3" ]
  deletion_policy     = "DEFAULT"
  restricted_actions  = [ "DELETE" ]
}

# Create a VmwareEngine Datastore, referencing the netapp volume
resource "google_vmwareengine_datastore" "example_netapp" {
  name        = "tf-test-netapp-datastore%{random_suffix}"
  location    = "%{region}"
  description = "%{description}"

  nfs_datastore {
    google_file_service {
      netapp_volume = google_netapp_volume.test_volume.id
    }
  }
}
`, context)
}

func testAccCheckVmwareengineDatastoreDestroyProducer(t *testing.T) func(s *terraform.State) error {
	return func(s *terraform.State) error {
		for name, rs := range s.RootModule().Resources {
			if rs.Type != "google_vmwareengine_datastore" {
				continue
			}
			if strings.HasPrefix(name, "data.") {
				continue
			}

			config := acctest.GoogleProviderConfig(t)

			url, err := tpgresource.ReplaceVarsForTest(config, rs, "{{VmwareengineBasePath}}projects/{{project}}/locations/{{location}}/datastores/{{name}}")
			if err != nil {
				return err
			}

			billingProject := ""

			if config.BillingProject != "" {
				billingProject = config.BillingProject
			}

			_, err = transport_tpg.SendRequest(transport_tpg.SendRequestOptions{
				Config:    config,
				Method:    "GET",
				Project:   billingProject,
				RawURL:    url,
				UserAgent: config.UserAgent,
			})
			if err == nil {
				return fmt.Errorf("VmwareengineDatastore still exists at %s", url)
			}
		}

		return nil
	}
}
