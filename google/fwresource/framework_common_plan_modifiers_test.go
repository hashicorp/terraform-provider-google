// Copyright (c) HashiCorp, Inc.
// SPDX-License-Identifier: MPL-2.0
// ----------------------------------------------------------------------------
//
//	***     AUTO GENERATED CODE    ***    Type: Handwritten     ***
//
// ----------------------------------------------------------------------------
//
//	This code is generated by Magic Modules using the following:
//
//	Source file: https://github.com/GoogleCloudPlatform/magic-modules/tree/main/mmv1/third_party/terraform/fwresource/framework_common_plan_modifiers_test.go
//
//	DO NOT EDIT this file directly. Any changes made to this file will be
//	overwritten during the next generation cycle.
//
// ----------------------------------------------------------------------------
package fwresource

import (
	"context"
	"strings"
	"testing"

	"github.com/hashicorp/terraform-plugin-go/tftypes"

	"github.com/hashicorp/terraform-plugin-framework/path"
	"github.com/hashicorp/terraform-plugin-framework/resource"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/planmodifier"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/stringplanmodifier"
	"github.com/hashicorp/terraform-plugin-framework/tfsdk"
	"github.com/hashicorp/terraform-plugin-framework/types"
	transport_tpg "github.com/hashicorp/terraform-provider-google/google/transport"
)

func TestDefaultProjectModify(t *testing.T) {
	testSchema := schema.Schema{
		Attributes: map[string]schema.Attribute{
			"project": schema.StringAttribute{
				Optional: true,
				Computed: true,
				PlanModifiers: []planmodifier.String{
					stringplanmodifier.UseStateForUnknown(),
				},
			},
		},
	}

	cases := map[string]struct {
		resourceSchema    schema.Schema
		providerConfig    *transport_tpg.Config
		expectedAttribute types.String
		expectError       bool
		errorContains     string
		req               resource.ModifyPlanRequest
		resp              *resource.ModifyPlanResponse
	}{
		"Prioritizes set config value": {
			providerConfig: &transport_tpg.Config{
				Project: "default-provider-project",
			},
			expectedAttribute: types.StringValue("plan-project"),
			req: resource.ModifyPlanRequest{
				Config: tfsdk.Config{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, "plan-project"),
					}),
					Schema: testSchema,
				},
				Plan: tfsdk.Plan{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, "plan-project"),
					}),
					Schema: testSchema,
				},
				State: tfsdk.State{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, nil),
					}),
					Schema: testSchema,
				},
			},

			resp: &resource.ModifyPlanResponse{
				Plan: tfsdk.Plan{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, "plan-project"),
					}),
					Schema: testSchema,
				},
			},
		},
		"Falls back on provider default": {
			providerConfig: &transport_tpg.Config{
				Project: "default-provider-project",
			},
			expectedAttribute: types.StringValue("default-provider-project"),
			req: resource.ModifyPlanRequest{
				Config: tfsdk.Config{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, nil),
					}),
					Schema: testSchema,
				},
				Plan: tfsdk.Plan{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, tftypes.UnknownValue),
					}),
					Schema: testSchema,
				},
				State: tfsdk.State{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, nil),
					}),
					Schema: testSchema,
				},
			},

			resp: &resource.ModifyPlanResponse{
				Plan: tfsdk.Plan{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, tftypes.UnknownValue),
					}),
					Schema: testSchema,
				},
			},
		},
		"Errors if there is no config value or provider default": {
			providerConfig: &transport_tpg.Config{},
			req: resource.ModifyPlanRequest{
				Config: tfsdk.Config{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, nil),
					}),
					Schema: testSchema,
				},
				Plan: tfsdk.Plan{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, tftypes.UnknownValue),
					}),
					Schema: testSchema,
				},
				State: tfsdk.State{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, nil),
					}),
					Schema: testSchema,
				},
			},

			resp: &resource.ModifyPlanResponse{
				Plan: tfsdk.Plan{
					Raw: tftypes.NewValue(tftypes.Object{
						AttributeTypes: map[string]tftypes.Type{
							"project": tftypes.String,
						},
					}, map[string]tftypes.Value{
						"project": tftypes.NewValue(tftypes.String, tftypes.UnknownValue),
					}),
					Schema: testSchema,
				},
			},
			expectError:   true,
			errorContains: "must be set",
		},
	}

	for name, tc := range cases {
		t.Run(name, func(t *testing.T) {
			ctx := context.Background()
			DefaultProjectModify(ctx, tc.req, tc.resp, tc.providerConfig.Project)
			if tc.resp.Diagnostics.HasError() {
				if tc.expectError {
					// Check if the error message contains the expected substring.
					if tc.errorContains != "" {
						found := false
						for _, d := range tc.resp.Diagnostics.Errors() {
							if strings.Contains(d.Detail(), tc.errorContains) {
								found = true
								break
							}
						}
						if !found {
							t.Fatalf("expected error to contain %q, but it did not. Got: %v", tc.errorContains, tc.resp.Diagnostics.Errors())
						}
					}
					// Correctly handled an expected error.
					return
				}
				t.Fatalf("unexpected error: %v", tc.resp.Diagnostics)
			}

			if tc.expectError {
				t.Fatal("expected an error, but got none")
			}

			var finalAttribute types.String
			tc.resp.Plan.GetAttribute(ctx, path.Root("project"), &finalAttribute)
			if !finalAttribute.Equal(tc.expectedAttribute) {
				t.Fatalf("incorrect attributes parsed.\n- got:  %v\n- want: %v", finalAttribute, tc.expectedAttribute)
			}
		})
	}
}
